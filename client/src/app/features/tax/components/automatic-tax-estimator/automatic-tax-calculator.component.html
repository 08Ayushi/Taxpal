<!-- Mobile drawer overlay -->
<div
  class="drawer-overlay"
  *ngIf="mobileNavOpen"
  (click)="closeMobileNav()"
  [class.open]="mobileNavOpen">
</div>

<!-- Sidebar -->
<div class="sidebar" [class.open]="mobileNavOpen" role="navigation" aria-label="Primary">
  <button
    type="button"
    class="close-mobile"
    aria-label="Close menu"
    (click)="closeMobileNav()">
    âœ•
  </button>

  <div>
    <h1><strong>TaxPal</strong></h1>

    <div class="menu">
      <a routerLink="/dashboard" (click)="closeMobileNavIfSmall()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M3 10.5 12 3l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-9.5Z"
            fill="currentColor" />
        </svg>
        <span>Dashboard</span>
      </a>

      <a routerLink="/transactions" (click)="closeMobileNavIfSmall()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M7 7h10v2H7V7Zm-2 4h14v2H5v-2Zm3 4h8v2H8v-2Z"
            fill="currentColor"
            opacity=".25" />
          <path
            d="M6.2 5.8 4.8 4.4A9 9 0 1 1 20 12h-2a7 7 0 1 0-11.8-6.2Z"
            fill="currentColor" />
          <path d="M15 11h7v2h-7z" fill="currentColor" opacity=".1" />
        </svg>
        <span>Transactions</span>
      </a>

      <a routerLink="/tax-calendar" (click)="closeMobileNavIfSmall()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" fill="currentColor" opacity=".12"/>
          <path d="M14 3v5h5" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linejoin="round"/>
          <path d="M8 12h8M8 16h8M8 8h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <span>Tax Calendar</span>
      </a>
      
      <a href="#" (click)="openBudget(); $event.preventDefault()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M12 3a9 9 0 1 0 9 9h-9V3Z"
            fill="currentColor"
            opacity=".2" />
          <path
            d="M12 3v9h9"
            stroke="currentColor"
            stroke-width="1.8"
            fill="none"
            stroke-linecap="round"
            stroke-linejoin="round" />
          <circle
            cx="12"
            cy="12"
            r="9"
            stroke="currentColor"
            stroke-width="1.2"
            fill="none" />
        </svg>
        <span>Budgets</span>
      </a>

      <a routerLink="/financial-reports" (click)="closeMobileNavIfSmall()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z"
            fill="currentColor"
            opacity=".12" />
          <path
            d="M14 3v5h5"
            stroke="currentColor"
            stroke-width="1.6"
            fill="none"
            stroke-linejoin="round" />
          <path
            d="M8 14h8M8 18h6"
            stroke="currentColor"
            stroke-width="1.6"
            stroke-linecap="round" />
        </svg>
        <span>Reports</span>
      </a>
    </div>
  </div>

  <div class="profile">
    <div class="profile-top">
      <div class="avatar">{{ firstInitial }}{{ secondInitial }}</div>
      <div class="who">
        <div class="name">{{ user?.name || 'User' }}</div>
        <div class="email">{{ user?.email || 'â€”' }}</div>
      </div>
    </div>

    <div class="profile-actions">
      <a
        [routerLink]="['/settings/categories']"
        class="action"
        (click)="closeMobileNavIfSmall()">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M19.14 12.94a7.96 7.96 0 0 0 .06-1 7.96 7.96 0 0 0-.06-1l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96c-.62-.24-1.2-.57-1.73-1l-.36-2.54a.5.5 0 0 0-.5-.43h-3.84a.5.5 0 0 0-.5.43l-.36 2.54c-.62-.24-1.2-.57-1.73-1l-2.39-.96a.5.5 0 0 0-.6.22L2.77 8.72a.5.5 0 0 0 .12.64L4.92 11a7.96 7.96 0 0 0-.06 1c0 .34.02.67.06 1l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32a.5.5 0 0 0 .6.22l2.39-.96c.53.42 1.11.76 1.73 1l.36 2.54a.5.5 0 0 0 .5.43h3.84a.5.5 0 0 0 .5-.43l.36-2.54c.62-.24 1.2-.57 1.73-1l2.39.96a.5.5 0 0 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64L19.14 12.94ZM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7Z" />
        </svg>
        <span>Settings</span>
      </a>

      <a href="#" class="action" (click)="auth.logout(); $event.preventDefault();">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path
            d="M16 17v-2h-5v-2h5V11l3 3-3 3ZM4 20h8a2 2 0 0 0 2-2v-2h-2v2H4V6h8v2h2V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z" />
        </svg>
        <span>Log Out</span>
      </a>
    </div>
  </div>
</div>

<!-- Main area -->
<div class="auto-main">
  <!-- Sticky header -->
  <div class="auto-sticky-header">
    <div class="auto-top-bar">
      <button
        type="button"
        class="hamburger"
        aria-label="Open menu"
        (click)="toggleMobileNav()">
        â‰¡
      </button>
    </div>

    <div class="auto-page-header">
      <h2 class="auto-page-title">Automated Tax Calculator</h2>
      <!-- <p class="auto-page-subtitle">Based on Indian Income Tax Rules</p> -->

      <button
        type="button"
        class="auto-header-close"
        aria-label="Close automatic tax calculator"
        (click)="onClose()">
        âœ•
      </button>
    </div>
  </div>

  <!-- Content -->
  <section class="auto-section">
    <!-- Loading / error states -->
    <div *ngIf="loading" class="loading-banner">
      Calculating your tax overview...
    </div>
    <div *ngIf="!loading && error" class="error-banner">
      {{ error }}
    </div>

    <!-- Top metric cards -->
    <div class="auto-cards-grid" *ngIf="!loading && !error">
      <div class="auto-card">
        <div class="auto-card-label">Total Income</div>
        <div class="auto-card-value">
          {{ currencyService.symbol }} {{ formatAmount(display.totalIncome) }}
        </div>
        <div class="auto-card-desc">From all transactions (current FY)</div>
      </div>

      <div class="auto-card">
        <div class="auto-card-label">Total Expenses</div>
        <div class="auto-card-value auto-card-negative">
          {{ currencyService.symbol }} {{ formatAmount(display.totalExpenses) }}
        </div>
        <div class="auto-card-desc">All deductible expenses (current FY)</div>
      </div>

      <div class="auto-card">
        <div class="auto-card-label">Taxable Income</div>
        <div class="auto-card-value">
          {{ currencyService.symbol }} {{ formatAmount(display.taxableIncome) }}
        </div>
        <div class="auto-card-desc">Total Income - Expenses</div>
      </div>

      <div class="auto-card">
        <div class="auto-card-label">Tax Payable</div>
        <div class="auto-card-value">
          {{ currencyService.symbol }} {{ formatAmount(display.taxPayable) }}
        </div>
        <div class="auto-card-desc">
          {{
            display.taxPayable > 0
              ? 'Estimated tax due'
              : 'No tax payable'
          }}
        </div>
      </div>
    </div>

    <!-- Bottom layout: Breakdown & Calendar -->
    <div class="auto-bottom-grid" *ngIf="!loading && !error">
      <!-- Breakdown -->
      <div class="breakdown-card">
        <h3 class="breakdown-title">Tax Calculation Breakdown</h3>

        <div class="breakdown-row">
          <span class="breakdown-label">Total Income</span>
          <span class="breakdown-value">
            {{ currencyService.symbol }} {{ formatAmount(display.totalIncome) }}
          </span>
        </div>

        <div class="breakdown-row">
          <span class="breakdown-label">Total Deductions (Expenses)</span>
          <span class="breakdown-value negative">
            - {{ currencyService.symbol }} {{ formatAmount(display.totalExpenses) }}
          </span>
        </div>

        <div class="breakdown-row highlight">
          <span class="breakdown-label">Taxable Income</span>
          <span class="breakdown-value">
            {{ currencyService.symbol }} {{ formatAmount(display.taxableIncome) }}
          </span>
        </div>

        <!-- No tax banner -->
        <div *ngIf="noTaxMessage" class="info-banner success">
          <div class="icon-dot"></div>
          <div class="info-text">
            {{ noTaxMessage }}
          </div>
        </div>

        <!-- Tax payable banner -->
        <div
          *ngIf="!noTaxMessage && display.taxPayable > 0"
          class="info-banner warning">
          <div class="icon-dot"></div>
          <div class="info-text">
            Tax is payable based on your calculated taxable income.
            Review the payment calendar for due dates.
          </div>
        </div>

        <!-- Slab-wise breakdown -->
        <div *ngIf="!noTaxMessage && slabs.length" class="slab-table">
          <div class="slab-header">
            <span>Tax Slabs Applied</span>
            <span>Tax Amount</span>
          </div>

          <div class="slab-row" *ngFor="let s of slabs">
            <span class="slab-label">
              {{ currencyService.symbol }} {{ formatAmount(s.from) }}
              â€“
              <ng-container *ngIf="s.to; else aboveLabel">
                {{ currencyService.symbol }} {{ formatAmount(s.to!) }}
              </ng-container>
              <ng-template #aboveLabel>Above</ng-template>
              @ {{ (s.rate * 100) | number:'1.0-0' }}%
            </span>
            <span class="slab-tax">
              {{ currencyService.symbol }} {{ formatAmount(s.tax) }}
            </span>
          </div>

          <div class="slab-total">
            <span>Total Tax</span>
            <span>{{ currencyService.symbol }} {{ formatAmount(display.taxPayable) }}</span>
          </div>
        </div>
      </div>

      <!-- Calendar -->
      <div class="calendar-card">
        <div class="calendar-header">
          <div class="calendar-icon">ðŸ“…</div>
          <h3 class="calendar-title">Tax Payment Calendar</h3>
        </div>

        <!-- No schedule -->
        <div *ngIf="!schedule.length && !!noTaxMessage" class="calendar-empty">
          <div class="calendar-empty-icon"></div>
          <div class="calendar-empty-title">No tax payments scheduled</div>
          <div class="calendar-empty-text">
            Your taxable income is below the configured threshold.
          </div>
        </div>

        <!-- Schedule list -->
        <div *ngIf="schedule.length" class="calendar-list">
          <div class="calendar-item" *ngFor="let item of schedule">
            <div class="calendar-row">
              <div>
                <div class="calendar-label">{{ item.label }}</div>
                <div class="calendar-period">{{ item.period }}</div>
              </div>
              <div class="calendar-amount">
                {{ currencyService.symbol }} {{ formatAmount(item.amount) }}
              </div>
            </div>
            <div class="calendar-row">
              <div class="calendar-due">
                Due:
                {{ item.dueDate | date:'MMM d, y' }}
              </div>
              <button
                type="button"
                class="calendar-paid-btn"
                (click)="markAsPaid(item)">
                Mark as Paid
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Budgets Modal -->
  <div class="modal-backdrop" *ngIf="showBudget" (click)="closeBudget()"></div>
  <div class="modal-shell" *ngIf="showBudget" (click)="closeBudget()" tabindex="-1">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-scroll">
        <app-budgets-list></app-budgets-list>
      </div>
    </div>
  </div>
</div>
