<!-- Mobile drawer overlay -->
<div
  class="drawer-overlay"
  *ngIf="mobileNavOpen"
  (click)="closeMobileNav()"
  [class.open]="mobileNavOpen">
</div>

<!-- Sidebar (desktop; off-canvas on small screens) -->
<div class="sidebar" [class.open]="mobileNavOpen" role="navigation" aria-label="Primary">
  <!-- Mobile close button -->
  <button type="button" class="close-mobile" aria-label="Close menu" (click)="closeMobileNav()">✕</button>

  <div>
    <h1><strong>TaxPal</strong></h1>

    <div class="menu">
      <a routerLink="/dashboard" (click)="closeMobileNavIfSmall()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M3 10.5 12 3l9 7.5V20a1 1 0 0 1-1 1h-5v-6H9v6H4a1 1 0 0 1-1-1v-9.5Z" fill="currentColor"/>
        </svg>
        <span>Dashboard</span>
      </a>

      <a routerLink="/transactions" (click)="closeMobileNavIfSmall()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M7 7h10v2H7V7Zm-2 4h14v2H5v-2Zm3 4h8v2H8v-2Z" fill="currentColor" opacity=".25"/>
          <path d="M6.2 5.8 4.8 4.4A9 9 0 1 1 20 12h-2a7 7 0 1 0-11.8-6.2Z" fill="currentColor" />
          <path d="M15 11h7v2h-7z" fill="currentColor" opacity=".1" />
        </svg>
        <span>Transactions</span>
      </a>

      <a routerLink="/tax-calendar" (click)="closeMobileNavIfSmall()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" fill="currentColor" opacity=".12"/>
          <path d="M14 3v5h5" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linejoin="round"/>
          <path d="M8 12h8M8 16h8M8 8h4" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <span>Tax Calendar</span>
      </a>

      <a href="#" (click)="openBudget(); $event.preventDefault()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 3a9 9 0 1 0 9 9h-9V3Z" fill="currentColor" opacity=".2" />
          <path d="M12 3v9h9" stroke="currentColor" stroke-width="1.8" fill="none" stroke-linecap="round" stroke-linejoin="round"/>
          <circle cx="12" cy="12" r="9" stroke="currentColor" stroke-width="1.2" fill="none"/>
        </svg>
        <span>Budgets</span>
      </a>

      <a routerLink="/financial-reports" (click)="closeMobileNavIfSmall()">
        <svg class="nav-ic" viewBox="0 0 24 24" aria-hidden="true">
          <path d="M7 3h7l5 5v13a1 1 0 0 1-1 1H7a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2Z" fill="currentColor" opacity=".12"/>
          <path d="M14 3v5h5" stroke="currentColor" stroke-width="1.6" fill="none" stroke-linejoin="round"/>
          <path d="M8 14h8M8 18h6" stroke="currentColor" stroke-width="1.6" stroke-linecap="round"/>
        </svg>
        <span>Reports</span>
      </a>
    </div>
  </div>

  <div class="profile">
    <div class="profile-top">
      <div class="avatar">{{ firstInitial }}{{ secondInitial }}</div>
      <div class="who">
        <div class="name">{{ user?.name || 'User' }}</div>
        <div class="email">{{ user?.email || '—' }}</div>
      </div>
    </div>

    <div class="profile-actions">
      <a [routerLink]="['/settings/categories']" class="action" (click)="closeMobileNavIfSmall()">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M19.14 12.94a7.96 7.96 0 0 0 .06-1 7.96 7.96 0 0 0-.06-1l2.03-1.58a.5.5 0 0 0 .12-.64l-1.92-3.32a.5.5 0 0 0-.6-.22l-2.39.96a7.44 7.44 0 0 0-1.73-1l-.36-2.54a.5.5 0 0 0-.5-.43h-3.84a.5.5 0 0 0-.5.43l-.36 2.54c-.62-.24-1.2-.57-1.73-1l-2.39-.96a.5.5 0 0 0-.6.22L2.77 8.72a.5.5 0 0 0 .12.64L4.92 11a7.96 7.96 0 0 0-.06 1c0 .34.02 .67.06 1l-2.03 1.58a.5.5 0 0 0-.12.64l1.92 3.32a.5.5 0 0 0 .6.22l2.39-.96c.53 .42 1.11 .76 1.73 1l.36 2.54a.5.5 0 0 0 .5 .43h3.84a.5.5 0 0 0 .5-.43l.36-2.54c.62-.24 1.2-.57 1.73-1l2.39 .96a.5.5 0 0 0 .6-.22l1.92-3.32a.5.5 0 0 0-.12-.64L19.14 12.94ZM12 15.5A3.5 3.5 0 1 1 12 8.5a3.5 3.5 0 0 1 0 7Z"/>
        </svg>
        <span>Settings</span>
      </a>

      <a href="#" class="action" (click)="onLogout($event)">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M16 17v-2h-5v-2h5V11l3 3-3 3ZM4 20h8a2 2 0 0 0 2-2v-2h-2v2H4V6h8v2h2V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v12a2 2 0 0 0 2 2Z"/>
        </svg>
        <span>Log Out</span>
      </a>
    </div>
  </div>
</div>

<!-- Main -->
<div class="main">
  <!-- === Sticky header (title + tabs + back) === -->
  <div class="sticky-header">
    <div class="top-bar">
      <button type="button" class="hamburger" aria-label="Open menu" (click)="toggleMobileNav()">≡</button>
    </div>

    <div class="page-header">
      <h1 class="page-title--brandlike">Tax Estimator</h1>

      <div class="header-actions" role="tablist" aria-label="Tax Estimator Tabs">
        <button
          class="tab-btn"
          [class.active]="activeTab==='form'"
          role="tab"
          aria-selected="{{activeTab==='form'}}"
          (click)="switchTab('form')">
          Tax Form
        </button>

        <button
          class="tab-btn"
          [class.active]="activeTab==='summary'"
          role="tab"
          aria-selected="{{activeTab==='summary'}}"
          (click)="switchTab('summary')">
          Summary
        </button>

        <!-- <a class="btn-back" [routerLink]="['/dashboard']" style="text-align: center;">Back to Dashboard</a> -->
      </div>
    </div>
  </div>
  <!-- === /Sticky header === -->

  <!-- Content (full-width under header) -->
  <section class="form-section">
    <!-- Tax Form -->
    <div class="form-card" *ngIf="activeTab==='form'">
      <div class="form-card-header">
        <h2 class="form-card-title">Quarterly Tax Calculator</h2>
        <button type="button" class="icon-btn" aria-label="Close tax estimator" (click)="onClose()">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
            <path d="M6 6l12 12M18 6l-12 12" stroke-linecap="round" stroke-linejoin="round"></path>
          </svg>
        </button>
      </div>

      <form [formGroup]="form" (ngSubmit)="calc()">
        <!-- Country / State -->
        <div class="grid grid-2">
          <div class="form-group">
            <label>Country/Region</label>
            <div class="select-wrap">
              <select class="input" formControlName="country">
                <option *ngFor="let c of countries" [value]="c">{{ c }}</option>
              </select>
              <svg class="chevron" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
              </svg>
            </div>
          </div>

          <div class="form-group">
            <label>State/Province</label>
            <div class="select-wrap">
              <select class="input" formControlName="state">
                <option *ngFor="let s of statesByCountry[form.value.country]">{{ s }}</option>
              </select>
              <svg class="chevron" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Filing / Quarter -->
        <div class="grid grid-2">
          <div class="form-group">
            <label>Filing Status</label>
            <div class="select-wrap">
              <select class="input" formControlName="status">
                <option *ngFor="let s of filingStatuses" [value]="s">{{ s }}</option>
              </select>
              <svg class="chevron" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
              </svg>
            </div>
          </div>

          <div class="form-group">
            <label>Quarter</label>
            <div class="select-wrap">
              <select class="input" formControlName="quarter">
                <option *ngFor="let q of quarters" [value]="q.id">{{ q.label }}</option>
              </select>
              <svg class="chevron" viewBox="0 0 20 20" fill="currentColor" aria-hidden="true">
                <path fill-rule="evenodd" d="M5.23 7.21a.75.75 0 011.06.02L10 10.94l3.71-3.71a.75.75 0 011.08 1.04l-4.25 4.25a.75.75 0 01-1.06 0L5.21 8.27a.75.75 0 01.02-1.06z" clip-rule="evenodd"/>
              </svg>
            </div>
          </div>
        </div>

        <!-- Income -->
        <div class="grid grid-1">
          <div class="form-group">
            <label>Gross Income for Quarter</label>
            <div class="currency-wrap">
              <span class="currency-prefix">$</span>
              <input
                class="input pl-currency"
                formControlName="grossIncome"
                type="number"
                min="0"
                step="0.01"
                placeholder="0.00"
                inputmode="decimal"
                (keydown)="blockInvalidNumberKeys($event)"
                (input)="onNumberInput('grossIncome', $event)"
                (wheel)="$event.target.blur()" />
            </div>
          </div>
        </div>

        <!-- Deductions -->
        <div class="grid grid-2">
          <div class="form-group">
            <label>Business Expenses</label>
            <div class="currency-wrap">
              <span class="currency-prefix">$</span>
              <input
                class="input pl-currency"
                formControlName="businessExpenses"
                type="number"
                min="0"
                step="0.01"
                placeholder="0.00"
                inputmode="decimal"
                (keydown)="blockInvalidNumberKeys($event)"
                (input)="onNumberInput('businessExpenses', $event)"
                (wheel)="$event.target.blur()" />
            </div>
          </div>

          <div class="form-group">
            <label>Retirement Contributions</label>
            <div class="currency-wrap">
              <span class="currency-prefix">$</span>
              <input
                class="input pl-currency"
                formControlName="retirement"
                type="number"
                min="0"
                step="0.01"
                placeholder="0.00"
                inputmode="decimal"
                (keydown)="blockInvalidNumberKeys($event)"
                (input)="onNumberInput('retirement', $event)"
                (wheel)="$event.target.blur()" />
            </div>
          </div>
        </div>

        <div class="grid grid-2">
          <div class="form-group">
            <label>Health Insurance Premiums</label>
            <div class="currency-wrap">
              <span class="currency-prefix">$</span>
              <input
                class="input pl-currency"
                formControlName="health"
                type="number"
                min="0"
                step="0.01"
                placeholder="0.00"
                inputmode="decimal"
                (keydown)="blockInvalidNumberKeys($event)"
                (input)="onNumberInput('health', $event)"
                (wheel)="$event.target.blur()" />
            </div>
          </div>

          <div class="form-group">
            <label>Home Office Deduction</label>
            <div class="currency-wrap">
              <span class="currency-prefix">$</span>
              <input
                class="input pl-currency"
                formControlName="homeOffice"
                type="number"
                min="0"
                step="0.01"
                placeholder="0.00"
                inputmode="decimal"
                (keydown)="blockInvalidNumberKeys($event)"
                (input)="onNumberInput('homeOffice', $event)"
                (wheel)="$event.target.blur()" />
            </div>
          </div>
        </div>

        <div class="actions">
          <button class="btn btn-primary" type="submit" [disabled]="status==='calculating'">
            {{ status==='calculating' ? 'Calculating…' : 'Calculate Estimated Tax' }}
          </button>
        </div>
      </form>
    </div>

    <!-- Summary -->
    <div class="form-card" *ngIf="activeTab==='summary'">
      <div class="form-card-header">
        <h2 class="form-card-title">Tax Summary</h2>
      </div>

      <div class="grid grid-1">
        <div class="form-group">
          <label>Gross Income</label>
          <div>{{ asCurrency(summary.gross) }}</div>
        </div>

        <div class="form-group">
          <label>Total Deductions</label>
          <div>- {{ asCurrency(summary.deductions) }}</div>
        </div>

        <div class="form-group">
          <label>Taxable Income</label>
          <div>{{ asCurrency(summary.taxable) }}</div>
        </div>

        <hr />

        <div class="form-group">
          <label><strong>Estimated Tax</strong></label>
          <div><strong>{{ asCurrency(summary.estimatedTax) }}</strong></div>
        </div>

        <div *ngIf="status==='idle'" style="color:#666; font-size: 13px; margin-top: 4px;">
          Enter details on the form tab and click “Calculate” for server-side save. Summary updates live locally.
        </div>
      </div>
    </div>
  </section>

  <!-- Inline snackbar outlet -->
  <div class="snack-container" aria-live="polite" aria-atomic="true">
    <div *ngFor="let s of snacks" class="snack" [ngClass]="s.kind">
      <span class="snack-text">{{ s.text }}</span>
      <button class="snack-close" (click)="dismissSnack(s.id)" aria-label="Dismiss">×</button>
    </div>
  </div>

  <!-- Budgets Modal -->
  <div class="modal-backdrop" *ngIf="showBudget" (click)="closeBudget()"></div>
  <div class="modal-shell" *ngIf="showBudget" (click)="closeBudget()" tabindex="-1">
    <div class="modal-content" (click)="$event.stopPropagation()">
      <div class="modal-scroll">
        <app-budgets-list></app-budgets-list>
      </div>
    </div>
  </div>
</div>
